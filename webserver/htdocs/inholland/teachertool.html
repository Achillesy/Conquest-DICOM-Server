<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Inholland teacher tool</title>
    <script src="vue.min.js"></script>
    <script src="axios.min.js"></script>
    <script type="text/javascript"> 
    
    // 20200119 changed 'study' to 'module'; allow same data to be used in multiple patients
    // 20200127 get patient info and uids; start implementing buttons; use deanonymize_script(*)
    // max time <10 minutes for conversion of 100 RTSTRUCTS, progress
    // check conversion has already been done is so warn
    // 20200202 Use '.' in stage and observer patient IDs; keep it in 9999,9000
    // 20200203 Added collateobservers and move 9999,9000 to deanonymize_script
    // 20200229 Scripted upload, refresh when done; started on swap buttons
    //          Note: for linux server copy dgate to dgate.exe to avoid reconfig here
    //          Also put uid in list, added < > and X buttons; update while typing patid
    // 20200301 Added swupdate; reordered components, image
    // 20200303 Added link to save uids and button to load uids for selected patient
    // 20200308 Fixed UIDMODS case
    
    function gup( name, url ) { // read cgi parameter
        if (!url) url = location.href;
        name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
        var regexS = "[\\?&]"+name+"=([^&#]*)";
        var regex = new RegExp( regexS );
        var results = regex.exec( url );
        return results == null ? null : results[1];
    }

    function put(url, json) {
      var a;
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
           if (this.readyState == 4 && this.status == 200) {
               a = this.responseText;
           }
      };
      xhttp.open("PUT", url, false);
      xhttp.setRequestHeader("Content-type", "application/json");
      xhttp.send(JSON.stringify(json));
      return a;
    }
    
    function post(url) {
      var a;
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
           if (this.readyState == 4 && this.status == 200) {
               a=this.responseText;
           }
      };
      xhttp.open("POST", url, false);
      xhttp.setRequestHeader("Content-type", "application/json");
      xhttp.send("");
      return a;
    }

    function readJSON(url) {
      var x = new XMLHttpRequest();
      var settings;
      x.onreadystatechange = function () {
        if (x.readyState===4 && x.status===200) {
          settings = JSON.parse(x.responseText);
        }
      }
      x.open("GET", url + '?_=' + new Date().getTime(), false);
      x.send();
      return settings;
    }
    
    // clear study or patient (unused and untested)
    function clear(server, study) {
      post(server+'?mode=start?parameter=sql&query=delete from UIDMODS where stage like "'+study+'%"');
      post(server+'?mode=start?parameter=sql&query=delete from DICOMImages where ImagePat like "'+study+'%"');
      post(server+'?mode=start?parameter=sql&query=delete from DICOMSeries where SeriesPat like "'+study+'%"');
      post(server+'?mode=start?parameter=sql&query=delete from DICOMStudies where PatientID like "'+study+'%"');
      post(server+'?mode=start?parameter=sql&query=delete from DICOMPatients where PatientID like "'+study+'%"');
    }

//        <tr><td># Sessions<td><input id=nsessions v-model:value=nsessions></tr>
//      <tr><td>Downsize<td><input id=reduceslices v-model:value=reduceslices></tr>
//        <tr><td>Slices of interest<td><input id=sliceofinterest v-model:value=sliceofinterest></tr>
   
    </script>
  </head>
  <body style="background:rgb(240,255,240)">
    <div class="row" style="width:1024" id=topper>
      <div class="column" style="float: left; width: 512">
        <h2>Welcome to the Inholland teacher tool</h2>
        <img src="Hermes_Io_Argus.jpg" height=140>
	<table>
	<tr><td><b>Study data:</b><td><INPUT TYPE=BUTTON VALUE='save'  v-on:click="savestudy">
	<A v-bind:href="server+'?mode=listpatients&patientidmatch='+study+'*'">[Explore]</a>
	<INPUT TYPE=BUTTON VALUE='clear' v-on:click="clearstudy">
	</tr>
        <tr><td>Module ID<td><input id=study v-model:value=study></tr>
        <tr><td>Current session<td><input id=session v-model:value=session></tr>
	<tr size=22><td><br><b>Patient data:</b>
	<td>
	<A v-bind:href="server+'?mode=wadostudyviewer&study='+patient+':'">[View]</a>
	<A v-bind:href="server+'?mode=liststudies&patientidmatch='+patient">[Explore]</a>
	<INPUT TYPE=BUTTON VALUE='clear' v-on:click="clearpatient">
	</tr>
        <tr><td>Patient ID<td><input id=study v-model:value=patient v-on:input="yourSetup">
        </tr>
  	<tr><td><b><br>Test observer data:</b></tr>
        <tr><td>Student ID<td><input id=observer v-model:value=observer></tr>
	<tr><td>Download <b>case data</b><td><a v-if="imagestudy" v-bind:href="server+'?mode=listpatients&parameter=zipanonymized&item='+patient+'|'+imagestudy+'||&newid='+patient+'.'+observer+'.'+session+'&stage='+study+'.'+patient+'.'+observer+'.'+session+'&dum=.zip'">for {{observer}}</a></tr>
	</table>
<br>
<hr>
<br>
        <FORM ID=gsform v-bind:ACTION="server" METHOD=POST ENCTYPE="multipart/form-data">
          <INPUT NAME=mode    TYPE=HIDDEN VALUE=attachfile>
          <INPUT NAME=script  TYPE=HIDDEN v-bind:value="'lua/anonymize_script.lua('+patient+'|'+study+'.'+patient+');lua/process_inholland.lua('+patient+'|'+study+'|goldstandard|'+session+'|'+gsname+')'">
          <INPUT NAME=port    TYPE=HIDDEN v-bind:value="serverport">
          <INPUT NAME=address TYPE=HIDDEN v-bind:value="serverip">
          Upload <b>gold standard</b> rtstruct for case {{patient}} (dcm):<br>
          Name <INPUT NAME=gsname v-model:value="gsname">
          <INPUT v-if="gsname" TYPE=BUTTON VALUE='Upload' v-on:click="upload('gsform')">	
	  <INPUT NAME=filetoupload SIZE=400 TYPE=file VALUE="">
        </FORM>
<br>
Number of gold standards: {{ countgs }}
<br>
<ul>
  <li v-for="item in gslist">
    {{ item.name }} <INPUT TYPE=BUTTON VALUE='X' v-on:click="deleter('gs', item.uid)"> <INPUT TYPE=BUTTON VALUE='>' v-on:click="swap('gs', item.uid)">
  </li>
</ul>
        <FORM ID=swupdateform v-bind:ACTION="server" METHOD=POST ENCTYPE="multipart/form-data">
          <INPUT NAME=mode    TYPE=HIDDEN VALUE=start>
          <INPUT NAME=parameter TYPE=HIDDEN VALUE=swupdate>
          <INPUT NAME=port    TYPE=HIDDEN v-bind:value="serverport">
          <INPUT NAME=address TYPE=HIDDEN v-bind:value="serverip">
          Upload <b>software</b> update:<br>
	  <INPUT NAME=filename TYPE=HIDDEN v-bind:value="filename">
	  <INPUT NAME=filetoupload SIZE=400 TYPE=file v-on:change="changefilename">
          <INPUT TYPE=BUTTON VALUE='Upload' v-on:click="upload('swupdateform')">	
        </FORM>
      </div>    
      <div class="column" style="float: left; width: 512; height: 2000">
<br>
<b>Server info for {{info}}:</b>
<br>
Number of patients in module: {{ countcases }}
<br>
        <h2>Data upload:</h2>
        <FORM ID=scanform v-bind:ACTION="server" METHOD=POST ENCTYPE="multipart/form-data">
          <INPUT NAME=mode    TYPE=HIDDEN VALUE=attachfile>
          <INPUT NAME=script  TYPE=HIDDEN v-bind:value=
	    "'lua/anonymize_script.lua('+patient+'|'+study+'.'+patient+');set StudyDescription to &quotSource data&quot;set SeriesDescription to &quot%VModality&quot'">
          <INPUT NAME=port    TYPE=HIDDEN v-bind:value="serverport">
          <INPUT NAME=address TYPE=HIDDEN v-bind:value="serverip">
          Upload <b>images</b> for case {{patient}} (zip):<br>
          <INPUT TYPE=BUTTON VALUE='Upload' v-on:click="upload('scanform')">	
	  <INPUT NAME=filetoupload size=40 TYPE=file VALUE="">
        </FORM>
        <FORM ID=templateform v-bind:ACTION="server" METHOD=POST ENCTYPE="multipart/form-data">
          <INPUT NAME=mode    TYPE=HIDDEN VALUE=attachfile>
          <INPUT NAME=script  TYPE=HIDDEN v-bind:value="'lua/anonymize_script.lua('+patient+'|'+study+'.'+patient+');lua/process_inholland.lua('+patient+'|'+study+'|template|'+session+')'">
          <INPUT NAME=port    TYPE=HIDDEN v-bind:value="serverport">
          <INPUT NAME=address TYPE=HIDDEN v-bind:value="serverip">
          Upload <b>template</b> rtstruct for case {{patient}} (dcm):<br>
          <INPUT TYPE=BUTTON VALUE='Upload' v-on:click="upload('templateform')">	
	  <INPUT NAME=filetoupload SIZE=400 TYPE=file VALUE="">
        </FORM>
	
        <INPUT TYPE=BUTTON VALUE='Collate teacher data' v-on:click="collateteacher">	
<br>
<br>
<b>Patient info for {{patient}}:</b>
<br>
Number of image slices: {{ countslices }}
<br>
Number of templates: {{ counttemplate }}
<br>
	<br>
Download <b>UIDs for </b><td><a v-if="imagestudy" v-bind:href="server+'?mode=start&parameter=serverpage&command=lua:returnfile=tempfile([[.txt]]);f=io.open(returnfile,[[w]]);f:write([[Content-type:%20application/text%0DContent-Disposition:%20attachment;filename=%22'+study+'.'+patient+'.sql%22%0D%0D]]);r=dbquery([[UIDMODS]],[[MODTime,OldUID,MODType,NewUID,Stage,Annotation]],[[Stage%20like%20%27'+study+'.'+patient+'%25%27]])for%20k,v%20in%20ipairs(r)do%20f:write([[insert%20into%20UIDMODS(MODTime,OldUID,MODType,NewUID,Stage,Annotation)%20values%20(%27]]..table.concat(v,[[%27,%27]])..[[%27);%0D]]);end;f:close()'">{{patient}}</a></tr>
        <FORM ID=uploadsqlform v-bind:ACTION="server" METHOD=POST ENCTYPE="multipart/form-data">
          <INPUT NAME=mode    TYPE=HIDDEN VALUE=start>
          <INPUT NAME=parameter TYPE=HIDDEN VALUE=uploadsql>
          <INPUT NAME=port    TYPE=HIDDEN v-bind:value="serverport">
          <INPUT NAME=address TYPE=HIDDEN v-bind:value="serverip">
          Upload <b>UIDs</b> for {{patient}}:<br>
	  <INPUT NAME=ref TYPE=HIDDEN v-bind:value="study+'.'+patient">
	  <INPUT NAME=filename TYPE=HIDDEN v-bind:value="filename">
	  <INPUT NAME=filetoupload SIZE=400 TYPE=file v-on:change="changefilename">
          <INPUT TYPE=BUTTON VALUE='Upload' v-on:click="upload('uploadsqlform')">	
        </FORM>
	<br>
	<hr>
	<br>
	
        <FORM ID=obsform v-bind:ACTION="server" METHOD=POST ENCTYPE="multipart/form-data">
          <INPUT NAME=mode    TYPE=HIDDEN VALUE=attachfile>
          <INPUT NAME=script  TYPE=HIDDEN v-bind:value="'lua/deanonymize_script.lua(*);lua/process_inholland.lua('+patient+'|'+study+'|'+observer+'|'+session+')'">
          <INPUT NAME=port    TYPE=HIDDEN v-bind:value="serverport">
          <INPUT NAME=address TYPE=HIDDEN v-bind:value="serverip">
          Upload <b>observer rtstruct</b> (dcm):<br>
          <INPUT TYPE=BUTTON VALUE='Upload' v-on:click="upload('obsform')">	
	  <INPUT NAME=filetoupload SIZE=200 TYPE=file VALUE="">
        </FORM>
        <INPUT TYPE=BUTTON VALUE='Collate observer data' v-on:click="collateobserver">	
	<A v-bind:href="'viewer.html?patient='+patient+'&session='+session+'&nslices='+countslices">[View]</a>
	
<h4>Observer data in system for {{patient}}:</h4>
Number of observers: {{ countobservers }}
<br>
<ul>
  <li v-for="item in obslist">
    <INPUT TYPE=BUTTON VALUE='<' v-on:click="swap('obs', item.uid)"> <INPUT TYPE=BUTTON VALUE='X' v-on:click="deleter('obs', item.uid)"> {{ item.name }} 
  </li>
</ul>
      </div>
    </div>
   <script type="text/javascript">
new Vue({
  el: '#topper',
  methods: {
    clearstudy: function (event) {
      alert('clear study');
    },
    savestudy: function (event) {
      alert('save study');
    },
    clearpatient: function (event) {
      alert('clear patient');
    },
    swap: function (location, item) {
      alert(location + ' ' + item);
    },
    deleter: function (location, item) {
      alert(location + ' ' + item);
    },
    drop: function (e) {
      console.log(e);
    },
    collateteacher: function (event) {
      axios
        .get(this.server+'?mode=start&parameter=servercommand&command=lua:command_line="'
	+this.patient+'|'+this.study+'|collateteacher";'
	+'dofile(Global.basedir.."lua/process_inholland.lua");return command_line')
        .then ( response => {
        alert(response.data)})
    },
    collateobserver: function (event) {
      axios
        .get(this.server+'?mode=start&parameter=servercommand&command=lua:command_line="'
	+this.patient+'|'+this.study+'|collateobservers";'
	+'dofile(Global.basedir.."lua/process_inholland.lua");return command_line')
        .then ( response => {
        alert(response.data)})
    },
    upload: function (formname) {
      const XHR = new XMLHttpRequest();
      const FD = new FormData( document.getElementById(formname) );
      var owner=this;
      XHR.addEventListener( "load", function(event) {
        //if ('swupdateform'==formname) 
	  alert( event.target.responseText );
        owner.yourSetup();
      } );
      XHR.addEventListener( "error", function( event ) {
        alert( 'Oops! Something went wrong.' );
      } );
      XHR.open( "POST", this.server );
      XHR.send( FD );
    },
    changefilename: function(e) {
     var files = e.target.files || e.dataTransfer.files;
     this.filename = files[0].name;
     if (this.filename.lastIndexOf('/')>0)
       this.filename = this.filename.substring(this.filename.lastIndexOf('/')+1);
     else
       this.filename = this.filename.substring(this.filename.lastIndexOf('\\')+1);
    },
    yourSetup: function() {
      axios
       .get(this.server+'?mode=start&parameter=countcases&study='+this.study)
        .then
        ( response => {
            this.countcases = response.data;
            if (this.patient==null) this.patient=this.study+'_'+(this.countcases+1);
          }
        )
      axios
       .get(this.server+'?mode=start&parameter=dicomquery&AE=CONQUESTSRV1&level=IMAGE&'+
          'query={QueryRetrieveLevel="IMAGE",PatientID="'+this.patient+'",SOPInstanceUID="",InstanceNumber="",ImageID="",Modality="",SeriesDescription="",StudyInstanceUID=""}')
        .then
        ( response => {
            this.countgs=0;
	    this.countslices=0;
	    this.counttemplate=0;
	    this.countobservers=0;
	    this.gslist=[];
	    this.obslist=[];
	    for (i=0; i<response.data.length; i++) {
	      if (response.data[i].Modality=='RTSTRUCT' && response.data[i].SeriesDescription=='Gold standard') {
	        this.gslist[this.countgs]={name:response.data[i].ImageID, uid:response.data[i].SOPInstanceUID};
	        this.countgs++;
	      }
	      if (response.data[i].Modality=='RTSTRUCT' && response.data[i].SeriesDescription=='Observers') {
	        this.obslist[this.countobservers]={name:response.data[i].ImageID, uid:response.data[i].SOPInstanceUID};
	        this.countobservers++;
	      }
	      if (response.data[i].Modality=='RTSTRUCT' && response.data[i].SeriesDescription=='Template') {
	        this.counttemplate++;
	      }
	      if (response.data[i].Modality=='CT') {
	        this.imagestudy = response.data[i].StudyInstanceUID;
	        this.countslices++;
	      }
	    }
          }
        )
    }
  },
  data () {
    return {
      info: "Not connected",
      study: gup('study') || 'ih_test',
      patient: gup('patient'),
      observer: gup('observer') || 'marcel',
      gsname: "",
      reduceslices: 1,
      nsessions: 1,
      session: 1,
      countcases: null,
      countgs: null,
      countslices: null,
      counttemplate: null,
      countobservers: null,
      imagestudy: null,
      sliceofinterest: "",
      server : "../../cgi-bin/newweb/dgate.exe",
      serverip : "127.0.0.1",
      serverport : "5678",
      gslist: null,
      obslist: null,
      filename: ""
    }
  },
  mounted () {
    axios
     .get(this.server+'?mode=start&parameter=test')
     .then(response => (this.info = response.data))
    this.yourSetup();
  }
})
   </script>
   </body>
 </html>
